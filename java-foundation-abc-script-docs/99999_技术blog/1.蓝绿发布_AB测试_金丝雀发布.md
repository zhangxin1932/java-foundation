#1.概述
```
目前，业界已经总结出了几种常见的服务发布策略来解决版本升级过程中带来的流量有损问题。
被业界广泛采用的服务发布策略包括:
>> 蓝绿发布
>> A/B 测试
>> 金丝雀发布

总结如下：
>> 蓝绿发布：
简单理解就是流量切换，依据热备的思想，冗余部署服务新版本。

>> A/B 测试：
简单理解就是根据请求内容（header、cookie）将请求流量路由到服务的不同版本。

>> 金丝雀发布：
是一种基于流量比例的发布策略，部署一个或者一小批新版本的服务，
将少量（比如 1%）的请求引流到新版本，逐步调大流量比重，直到所有用户流量都被切换新版本为止。

云原生网关以托管的方式来作为您的流量入口，提供了丰富的流量治理能力，支持多种服务发现方式，
如 K8s Service、Nacos、Eurake、ECS 和域名，并以统一的模型支持了服务版本以及灰度发布能力。
在上面的实践中，可以发现两种服务发现方式仅仅是元数据信息所处的位置不同，
但服务版本管理以及路由规则中的灰度发布模型都是一致的，
您可以轻松学会为不同服务发现方式的服务进行灰度发布，确保版本升级过程中平滑无损。
```

#2.蓝绿发布
```
#1.概述
蓝绿发布需要对服务的新版本进行冗余部署，一般新版本的机器规格和数量与旧版本保持一致，
相当于该服务有两套完全相同的部署环境，只不过此时只有旧版本在对外提供服务，新版本作为热备。
当服务进行版本升级时，我们只需将流量全部切换到新版本即可，旧版本作为热备。
由于冗余部署的缘故，所以不必担心新版本的资源不够。
如果新版本上线后出现严重的程序 BUG，那么我们只需将流量全部切回至旧版本，大大缩短故障恢复的时间。
待新版本完成 BUG 修复并重新部署之后，再将旧版本的流量切换到新版本。

蓝绿发布通过使用额外的机器资源来解决服务发布期间的不可用问题，
当服务新版本出现故障时，也可以快速将流量切回旧版本。

#2.示例
## 2.1如图，某服务旧版本为 v1，对新版本 v2 进行冗余部署。
版本升级时，将现有流量全部切换为新版本 v2。
请求 --> 网关 --> 100% --> v1
             --> 0%   --> v2
[升级之后]:
请求 --> 网关 --> 0%   --> v1
             --> 100% --> v2

##2.2 当新版本 v2 存在程序 BUG 或者发生故障时，可以快速切回旧版本 v1。
请求 --> 网关 --> 0%   --> v1
             --> 100% --> v2
[回滚之后]:
请求 --> 网关 --> 100% --> v1
             --> 0%   --> v2


3.蓝绿部署的优点：
>> 部署结构简单，运维方便；
>> 服务升级过程操作简单，周期短。

4.蓝绿部署的缺点：
>> 资源冗余，需要部署两套生产环境；
>> 新版本故障影响范围大。
```

#3.A/B 测试
```
#1.概述
相比于蓝绿发布的流量切换方式，A/B 测试基于用户请求的元信息将流量路由到新版本，
这是一种基于请求内容匹配的灰度发布策略。只有匹配特定规则的请求才会被引流到新版本，
常见的做法包括基于 Http Header 和 Cookie。基于 Http Header 方式的例子，
例如 User-Agent 的值为 Android 的请求 （来自安卓系统的请求）可以访问新版本，
其他系统仍然访问旧版本。基于 Cookie 方式的例子，
Cookie 中通常包含具有业务语义的用户信息，
例如普通用户可以访问新版本，VIP 用户仍然访问旧版本。

#2.示例
##2.1 部分上线
如图，某服务当前版本为 v1，现在新版本 v2 要上线。
希望安卓用户可以尝鲜新功能，其他系统用户保持不变。
请求 --> 网关 --> 100% --> v1
             --> 0%   --> v2
[升级之后]:
请求 --> 网关                     --> x%   --> v1
            (user-agent:Andriod) --> y%   --> v2
##2.2 逐步下线老版本
通过在监控平台观察旧版本与新版本的成功率、RT 对比，当新版本整体服务预期后，
即可将所有请求切换到新版本 v2，最后为了节省资源，可以逐步下线到旧版本 v1。
请求 --> 网关 --> 0%   --> v1
             --> 100% --> v2

#3.A/B 测试的优点：
>> 可以对特定的请求或者用户提供服务新版本，新版本故障影响范围小；
>> 需要构建完备的监控平台，用于对比不同版本之间请求状态的差异。
   
#4.A/B 测试的缺点：
>> 仍然存在资源冗余，因为无法准确评估请求容量；
>> 发布周期长。
```

#4.金丝雀发布
```
#1.概述
>> 在蓝绿发布中，由于存在流量整体切换，所以需要按照原服务占用的机器规模为新版本克隆一套环境，
相当于要求原来 1 倍的机器资源。
>> 在 A/B 测试中，只要能够预估中匹配特定规则的请求规模，我们可以按需为新版本分配额外的机器资源。

相比于前两种发布策略，金丝雀发布的思想则是将少量的请求引流到新版本上，
因此部署新版本服务只需极小数的机器。验证新版本符合预期后，逐步调整流量权重比例，
使得流量慢慢从老版本迁移至新版本，期间可以根据设置的流量比例，
对新版本服务进行扩容，同时对老版本服务进行缩容，使得底层资源得到最大化利用。

#2.示例
如图，某服务当前版本为 v1，现在新版本 v2 要上线。
为确保流量在服务升级过程中平稳无损，采用金丝雀发布方案，逐步将流量从老版本迁移至新版本。
请求 --> 网关 --> 100% --> v1
             --> 0%   --> v2
[第一次升级之后]:
请求 --> 网关 --> 99%   --> v1
             --> 1%    --> v2
[第二次升级之后]:
请求 --> 网关 --> 50%   --> v1
             --> 50%   --> v2
[第n次升级之后]:
请求 --> 网关 --> 0%    --> v1
             --> 100%  --> v2

#3.金丝雀发布的优点：
>> 按比例将流量无差别地导向新版本，新版本故障影响范围小；
>> 发布期间逐步对新版本扩容，同时对老版本缩容，资源利用率高。
   
#4.金丝雀发布的缺点：
>> 流量无差别地导向新版本，可能会影响重要用户的体验；
>> 发布周期长。
```

```参考资料```
https://my.oschina.net/u/4518070/blog/5440439